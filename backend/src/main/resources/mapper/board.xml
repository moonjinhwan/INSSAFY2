<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.pjt1.model.mapper.BoardMapper">

	<insert id="createBoard" parameterType="BoardDto" useGeneratedKeys="true" keyProperty="board_id">
		insert into board (board_name, board_description, board_image, board_igmyeong,
		board_location,board_hash,board_date,user_id,is_used)
		values ( #{board_name}, #{board_description}, #{board_image}, #{board_igmyeong} ,
		#{board_location}, #{board_hash}, now(), #{user_id},1)
	</insert>
	
	<insert id="subscribe" parameterType="map">
		insert into subscription values (
		#{board_id}, #{user_id}, 0, 0, #{user_role}, 1
		)
	</insert>
	
	<insert id="addFunction" parameterType="map">
		insert into add_function values (
		#{board_id}, #{checklist_flag}, #{calendar_flag}, #{vote_flag}, 1
		)
	</insert>
	
	<select id="isSubscribed" parameterType="map" resultType="int">
		select count(*)
		from subscription 
		where board_id = #{board_id} and user_id = #{user_id};	
	</select>
	
	<select id="isUnSubscribed" parameterType="map" resultType="int">
		select count(*)
		from subscription 
		where board_id = #{board_id} and user_id = #{user_id} and is_used = 1;	
	</select>

	<update id="updateSubscribe"> 
		update subscription 
		set is_used = 1
		where board_id = #{board_id} and user_id = #{user_id};
	</update>

	<update id="unsubscribe"> 
		update subscription 
		set is_used = 0
		where board_id = #{board_id} and user_id = #{user_id} and user_role != 1;
	</update>

	<select id="searchUser" parameterType="string" resultType="UserDto">
		select *
		from user
		where user_email like concat('%',#{user_name} ,'%') and is_used = 1;
	</select>
	
	<update id="updateManager" parameterType="map">
		update subscription
		set user_role = 1
		where board_id = #{board_id} and user_id = #{user_id};
	</update>

	<update id="modifyBoard" parameterType="BoardDto">
		update board
		set board_name = #{board_name}, board_description = #{board_description}, board_image=#{board_image}, 
		board_igmyeong=#{board_igmyeong}, board_location=#{board_location}, board_hash=#{board_hash}
		where board_id = #{board_id}
	</update>

	<select id="getBoardsNew" resultType="BoardDto">
		select *
		from board
		where is_used = 1
		order by board_date desc;
	</select>

	<select id="getBoardsPopular" resultType="BoardDto">
		select *
		from board as b left outer join (select count(board_id) as board_count, board_id from subscription group by board_id) as c 
		on b.board_id = c.board_id
		where b.is_used = 1
		order by c.board_count desc;
	</select>

	<select id="searchBoardNew" parameterType="string" resultType="BoardDto">
		select *
		from board
		where ( board_name like concat('%',#{keyword} ,'%') or board_description like concat('%',#{keyword} ,'%')
		or board_hash like concat('%',#{keyword} ,'%') ) and is_used = 1
		order by board_date desc;
	</select>

	<select id="searchBoardPopular" parameterType="string" resultType="BoardDto">
		select *
		from board as b join (select count(board_id) as board_count, board_id from subscription group by board_id) as c 
		on b.board_id = c.board_id
		where ( b.board_name like concat('%',#{keyword} ,'%') or b.board_description like concat('%',#{keyword} ,'%')
		or b.board_hash like concat('%',#{keyword} ,'%') ) and b.is_used = 1
		order by c.board_count desc;
	</select>

	<update id="deleteBoard" parameterType="int">
		update board
		set is_used = 0
		where board_id=#{board_id}
	</update>

	<select id="detailBoard" parameterType="int" resultType="BoardDto">
		select *
		from board 
		where board_id = #{board_id} and is_used = 1
	</select>

	<update id="deleteBoardAll" parameterType="int">
		update add_function
		set is_used = 0
		where board_id=#{board_id}
	</update>

	<update id="deleteSubscription" parameterType="int">
		update subscription
		set is_used = 0
		where board_id=#{board_id}
	</update>

	<update id="deletePostAll" parameterType="int">
		update post
		set is_used = 0
		where board_id=#{board_id}
	</update>

	<update id="deleteCalendar" parameterType="int">
		update calendar_item
		set is_used = 0
		where board_id=#{board_id}
	</update>

	<update id="deleteCheckList" parameterType="int">
		update check_list_item
		set is_used = 0
		where board_id=#{board_id}
	</update>

	<update id="deleteVote" parameterType="int">
		update vote
		set is_used = 0
		where board_id=#{board_id}
	</update>

	<select id="getVoteList" parameterType="int" resultType="int">
		select vote_id
		from vote
		where board_id = #{board_id} and is_used = 1;
	</select>

	<select id="getPostList" parameterType="int" resultType="int">
		select post_id
		from post
		where board_id = #{board_id} and is_used = 1;
	</select>

	<select id="getBoardCount" resultType="int">
		select count(*)
		from subscription
		where board_id = #{board_id} and is_used = 1;
	</select>

	<select id="getIdbyPostId" resultType="int">
		select board_id
		from post
		where post_id = #{post_id} and is_used = 1;
	</select>

	<select id="isManager" parameterType="map" resultType="int">
		select count(*)
		from subscription
		where board_id = #{board_id} and user_id = #{login_id} and is_used = 1
		and user_role = 1;	
	</select>
</mapper>
